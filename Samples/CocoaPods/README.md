# CocoaPods Sample - Clix iOS SDK

A sample iOS application demonstrating the integration of the Clix iOS SDK using CocoaPods dependency manager for push notifications and user analytics.

## Features

- Push notification handling with Firebase Cloud Messaging (FCM)
- Rich push notifications with images via Notification Service Extension
- User identification and custom properties
- Event tracking
- Deep link handling from notifications
- SwiftUI-based user interface
- **CocoaPods integration** for dependency management

## Prerequisites

- Xcode 15.0 or later
- iOS 15.0 or later
- Swift 5.5 or later
- CocoaPods 1.10.0 or later
- Firebase project with Cloud Messaging enabled
- Clix project credentials

## Setup Instructions

### 1. Install CocoaPods

If you haven't installed CocoaPods yet:

```bash
sudo gem install cocoapods
```

### 2. Install Dependencies

Navigate to the CocoaPods sample directory and install pods:

```bash
cd Samples/CocoaPods
pod install
```

This will:
- Install the Clix SDK from the local repository (`../../`)
- Install Firebase dependencies automatically
- Generate `BasicApp.xcworkspace`

### 3. Configure Firebase

1. Download your `GoogleService-Info.plist` from Firebase Console
2. Add it to `Samples/BasicApp/Resources/` directory (shared with BasicApp sample)

### 4. Configure Clix SDK

1. Navigate to the BasicApp directory and copy the example configuration file:
   ```bash
   cd ../BasicApp
   cp ClixConfig.json.example Resources/ClixConfig.json
   ```

2. Edit `Resources/ClixConfig.json` with your Clix project credentials:
   ```json
   {
     "projectId": "your-project-id",
     "apiKey": "your-api-key",
     "endpoint": "https://api.clix.so",
     "extraHeaders": {}
   }
   ```

### 5. Configure App Groups

The SDK uses App Groups to share data between the main app and Notification Service Extension.

1. **Main App Target (BasicApp)**:
   - Open `BasicApp.xcworkspace` in Xcode
   - Select BasicApp target
   - Go to "Signing & Capabilities" tab
   - Click "+ Capability" → Add "App Groups"
   - Add group: `group.clix.so.clix.samples.basic`

2. **Notification Service Extension Target (ClixNotificationExtension)**:
   - Select ClixNotificationExtension target
   - Go to "Signing & Capabilities" tab
   - Click "+ Capability" → Add "App Groups"
   - Add the **same** group: `group.clix.so.clix.samples.basic`

### 6. Configure Development Team

1. In Xcode, select the project in the navigator
2. For both targets (BasicApp and ClixNotificationExtension):
   - Go to "Signing & Capabilities" tab
   - Select your development team

### 7. Build and Run

**IMPORTANT**: Always open the `.xcworkspace` file, not the `.xcodeproj` file when using CocoaPods.

```bash
# Open workspace in Xcode
open BasicApp.xcworkspace

# Or build from command line
xcodebuild -workspace BasicApp.xcworkspace -scheme BasicApp -configuration Debug
```

## Project Structure

```
CocoaPods/
├── Sources/                      # Symlink to ../BasicApp/Sources
├── Resources/                    # Symlink to ../BasicApp/Resources
├── ClixNotificationExtension/    # Symlink to ../BasicApp/ClixNotificationExtension
├── BasicApp.xcodeproj            # Xcode project configured for CocoaPods
├── BasicApp.xcworkspace          # Workspace (generated by pod install)
├── Podfile                       # CocoaPods dependency specification
├── Podfile.lock                  # Locked dependency versions
├── Pods/                         # Installed pods (generated by pod install)
└── README.md                     # This file
```

**Note**: This sample shares source code, resources, and extension with the BasicApp sample via symbolic links. The only difference is the dependency management approach (CocoaPods vs SPM).

## Podfile Configuration

The `Podfile` specifies the Clix SDK as a local pod for development:

```ruby
platform :ios, '15.0'

target 'BasicApp' do
  use_frameworks!
  pod 'Clix', :path => '../..'
end

target 'ClixNotificationExtension' do
  use_frameworks!
  pod 'Clix', :path => '../..'
end
```

**For production**: Replace the local path with the CocoaPods spec:
```ruby
pod 'Clix', '~> 1.0'
```

## Key Implementation Details

### AppDelegate Integration

The app uses `ClixAppDelegate` for automatic push notification setup:

```swift
class AppDelegate: ClixAppDelegate {
  override func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    // Configure Firebase BEFORE calling super
    FirebaseApp.configure()

    // Initialize Clix SDK with config loaded from JSON
    Clix.initialize(config: ClixConfiguration.config)

    return super.application(application, didFinishLaunchingWithOptions: launchOptions)
  }
}
```

### Configuration Loading

Configuration is loaded from `ClixConfig.json` at runtime and provides a ready-to-use `ClixConfig` instance:

```swift
enum ClixConfiguration {
  static let config: ClixConfig = {
    guard let url = Bundle.main.url(forResource: "ClixConfig", withExtension: "json"),
          let data = try? Data(contentsOf: url),
          let json = try? JSONSerialization.jsonObject(with: data) as? [String: Any] else {
      fatalError("Failed to load ClixConfig.json")
    }

    guard let projectId = json["projectId"] as? String,
          let apiKey = json["apiKey"] as? String,
          let endpoint = json["endpoint"] as? String else {
      fatalError("ClixConfig.json is missing required fields")
    }

    let extraHeaders = json["extraHeaders"] as? [String: String] ?? [:]

    return ClixConfig(
      projectId: projectId,
      apiKey: apiKey,
      endpoint: endpoint,
      logLevel: .debug,
      extraHeaders: extraHeaders
    )
  }()
}
```

**Usage**: Simply pass `ClixConfiguration.config` to `Clix.initialize()` - the configuration is loaded once and cached automatically.

### Rich Notification Extension

The Notification Service Extension handles rich push notifications with images:

```swift
class NotificationService: ClixNotificationServiceExtension {
  override init() {
    super.init()
    register(projectId: ClixConfiguration.config.projectId)
  }
}
```

## CocoaPods vs SPM

### Advantages of CocoaPods
- More mature ecosystem with broader package support
- Better version locking with `Podfile.lock`
- Easier to configure complex dependency trees
- Better support for older Xcode versions

### When to Use CocoaPods
- Your project already uses CocoaPods
- You need dependencies not available via SPM
- You prefer centralized dependency management
- You need more control over build settings per pod

### When to Use SPM (BasicApp sample)
- You prefer native Xcode integration
- You want simpler project structure (no Pods directory)
- You're building a new project
- You want faster dependency resolution

## Updating Dependencies

To update the Clix SDK and other dependencies:

```bash
# Update to latest versions
pod update

# Or update only Clix
pod update Clix

# Reinstall specific versions
pod install
```

## Testing Push Notifications

1. **Run on a physical device** (Push notifications don't work on iOS 26 simulator)
2. Allow notifications when prompted
3. Send a test notification from Firebase Console or Clix dashboard
4. Check device logs for SDK initialization and notification handling

## Troubleshooting

### Pod install fails

- Ensure you have the latest CocoaPods version: `sudo gem install cocoapods`
- Clean CocoaPods cache: `pod cache clean --all`
- Delete `Podfile.lock` and `Pods/` directory, then run `pod install` again

### Workspace not opening

- Make sure you're opening `BasicApp.xcworkspace`, not `BasicApp.xcodeproj`
- Run `pod install` to regenerate the workspace if needed

### Build errors after pod install

- Clean build folder: Xcode → Product → Clean Build Folder (Shift+Cmd+K)
- Delete derived data: `rm -rf ~/Library/Developer/Xcode/DerivedData/*`
- Restart Xcode

### App crashes on launch with "Failed to load ClixConfig.json"

- Ensure `ClixConfig.json` exists in `../BasicApp/Resources/` directory
- Verify the JSON is valid and contains all required fields
- Check that the Resources symlink is working: `ls -la Resources/`

### Firebase token not collected

- Verify `GoogleService-Info.plist` is in `../BasicApp/Resources/` directory
- Ensure `FirebaseApp.configure()` is called BEFORE `Clix.initialize()` in AppDelegate
- Check that APNs is properly configured in Firebase Console
- Verify Firebase pods are installed: check `Pods/` directory

### Notifications not appearing

- Verify App Groups are configured correctly in both targets
- Check that notification permissions are granted
- Ensure device is registered in Clix dashboard
- Review device logs for errors

### Rich notifications (images) not loading

- Verify Notification Service Extension has the same App Group configuration
- Check that `ClixConfiguration.config.projectId` is accessible in the extension
- Review extension logs in Console app
- Ensure the extension target has Clix pod dependency in Podfile

## Additional Resources

- [Clix iOS SDK Documentation](../../README.md)
- [CocoaPods Getting Started](https://guides.cocoapods.org/using/getting-started.html)
- [CocoaPods Podfile Syntax](https://guides.cocoapods.org/syntax/podfile.html)
- [Firebase Cloud Messaging Setup](https://firebase.google.com/docs/cloud-messaging/ios/client)
- [App Groups Documentation](https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_security_application-groups)

## License

See the main SDK [LICENSE](../../LICENSE) file for details.
